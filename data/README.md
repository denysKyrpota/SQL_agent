# Data Directory

This directory contains application data, including knowledge base examples, schema snapshots, database files, and query exports.

**Important:** This directory is empty in the repository for security reasons. All data files are gitignored to protect your database structure and business logic.

## Directory Structure

```
data/
├── knowledge_base/      # SQL query examples for RAG (gitignored)
├── schema/             # PostgreSQL schema JSON snapshots (gitignored)
├── app_data/           # SQLite database files (gitignored)
└── exports/            # Query result CSV exports (gitignored)
```

You must generate these files by connecting to your own PostgreSQL database.

## Knowledge Base (`knowledge_base/`)

Contains SQL query examples used for Retrieval-Augmented Generation (RAG). The system uses these examples to improve SQL generation accuracy.

### File Format

Each `.sql` file should follow this format:

```sql
-- Title of the query
-- Description: Optional description of what the query does

SELECT ...
FROM ...
WHERE ...
```

### Creating Your Knowledge Base

1. **Add your SQL examples:**

   Create `.sql` files in `data/knowledge_base/` with this format:
   ```sql
   -- Title of the query
   -- Description: Optional description

   SELECT ...
   FROM ...
   WHERE ...
   ```

2. **Generate embeddings:**
   ```bash
   curl -X POST http://localhost:8000/api/admin/knowledge-base/embeddings/generate \
     -H "Authorization: Bearer <admin_token>"
   ```

3. **Restart the backend** or use the refresh endpoint:
   ```bash
   curl -X POST http://localhost:8000/api/admin/knowledge-base/refresh \
     -H "Authorization: Bearer <admin_token>"
   ```

### Embeddings

The `embeddings.json` file stores pre-computed vector embeddings for all knowledge base examples. This file is:
- Auto-generated by the system
- Gitignored (not committed to repository)
- Regenerated when you add new SQL examples

## Schema (`schema/`)

Contains PostgreSQL database schema snapshots in JSON format. The system uses these to understand table structures, relationships, and generate accurate SQL.

### Schema Files

When you generate your schema, five JSON files will be created:

1. **`tables.json`** - List of all available tables
2. **`columns__data_types__and_nullable_status.json`** - Column definitions
3. **`primary_keys__system_catalog_version.json`** - Primary key constraints
4. **`foreign_key_relationships__source_→_target.json`** - Foreign key relationships
5. **`all_in_one_schema_overview__tables__columns__pks__fks__descriptions.json`** - Complete schema

**All schema files are gitignored** to protect your database structure.

### Refreshing Schema

To update schema from your PostgreSQL database:

```bash
curl -X POST http://localhost:8000/api/admin/schema/refresh \
  -H "Authorization: Bearer <admin_token>"
```

This reads the current schema from PostgreSQL and updates all JSON files.

## Application Data (`app_data/`)

Contains SQLite database files for application data:
- `sqlite.db` - Main database (users, sessions, query history, conversations)
- `*.db-shm`, `*.db-wal` - SQLite temporary files

**These files are gitignored** and should never be committed.

## Exports (`exports/`)

Stores CSV exports of query results (up to 10,000 rows per export).

**These files are gitignored** and should never be committed.

## Security Considerations

### What NOT to Commit

1. **Knowledge Base Files** - Contain business logic and sensitive queries
2. **Schema Files** - Reveal database structure and table relationships
3. **Database Files** - Contain user data and session tokens
4. **CSV Exports** - May contain customer or business data
5. **Embeddings** - Can be regenerated, no need to commit

### .gitignore Configuration

The root `.gitignore` excludes ALL data files automatically:

```gitignore
# All data files are excluded for security
data/knowledge_base/*.sql
data/schema/*.json
data/knowledge_base/embeddings.json
data/app_data/*.db*
data/exports/*
```

This ensures your database structure and business logic remain private.

## Getting Started

### First-Time Setup

1. **Configure PostgreSQL Connection:**
   ```bash
   # Edit .env file
   POSTGRES_URL=postgresql://user:password@host:port/dbname
   ```

2. **Initialize Application Database:**
   ```bash
   make db-init  # Creates SQLite database with default users
   python -m backend.app.main  # Start server
   ```

3. **Generate Schema Snapshot:**
   ```bash
   # Login as admin and get token
   curl -X POST http://localhost:8000/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","password":"admin123"}'

   # Generate schema files
   curl -X POST http://localhost:8000/api/admin/schema/refresh \
     -H "Authorization: Bearer <admin_token>"
   ```

4. **Add Knowledge Base Examples:**
   ```bash
   # Create .sql files in data/knowledge_base/
   # Then generate embeddings
   curl -X POST http://localhost:8000/api/admin/knowledge-base/embeddings/generate \
     -H "Authorization: Bearer <admin_token>"
   ```

## Troubleshooting

### Schema Not Loading

If schema files are missing:
1. Check `POSTGRES_URL` in `.env`
2. Use admin endpoint to refresh: `/api/admin/schema/refresh`
3. Verify PostgreSQL connection

### Embeddings Missing

If `embeddings.json` is missing:
1. Use admin endpoint: `/api/admin/knowledge-base/embeddings/generate`
2. Check `OPENAI_API_KEY` in `.env`
3. Verify knowledge base has `.sql` files

### Permission Errors

Ensure the `data/` directory has write permissions for:
- Generating embeddings (`embeddings.json`)
- Creating database files (`app_data/*.db`)
- Exporting results (`exports/*.csv`)
