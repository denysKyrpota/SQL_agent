# Data Directory

This directory contains application data, including knowledge base examples, schema snapshots, database files, and query exports.

## Directory Structure

```
data/
├── knowledge_base/      # SQL query examples for RAG
├── schema/             # PostgreSQL schema JSON snapshots
├── app_data/           # SQLite database files (gitignored)
└── exports/            # Query result CSV exports (gitignored)
```

## Knowledge Base (`knowledge_base/`)

Contains SQL query examples used for Retrieval-Augmented Generation (RAG). The system uses these examples to improve SQL generation accuracy.

### File Format

Each `.sql` file should follow this format:

```sql
-- Title of the query
-- Description: Optional description of what the query does

SELECT ...
FROM ...
WHERE ...
```

### Sample vs. Production Files

- **Sample files** (`sample_*.sql`): Generic examples for demonstration
- **Production files** (all other `.sql`): Your actual business queries (gitignored)

**Current sample files:**
- `sample_employees_by_department.sql` - Employee listing by department
- `sample_orders_last_30_days.sql` - Recent orders with customer info
- `sample_product_inventory_status.sql` - Product stock levels
- `sample_monthly_sales_summary.sql` - Monthly sales aggregation

### Using Your Own Knowledge Base

1. **Add your SQL examples:**
   ```bash
   cp your_queries/*.sql data/knowledge_base/
   ```

2. **Generate embeddings:**
   ```bash
   curl -X POST http://localhost:8000/api/admin/knowledge-base/embeddings/generate \
     -H "Authorization: Bearer <admin_token>"
   ```

3. **Restart the backend** or use the refresh endpoint:
   ```bash
   curl -X POST http://localhost:8000/api/admin/knowledge-base/refresh \
     -H "Authorization: Bearer <admin_token>"
   ```

### Embeddings

The `embeddings.json` file stores pre-computed vector embeddings for all knowledge base examples. This file is:
- Auto-generated by the system
- Gitignored (not committed to repository)
- Regenerated when you add new SQL examples

## Schema (`schema/`)

Contains PostgreSQL database schema snapshots in JSON format. The system uses these to understand table structures, relationships, and generate accurate SQL.

### Schema Files

Five JSON files provide complete schema information:

1. **`tables.json`** - List of all available tables
   ```json
   [{"table_schema":"public","table_name":"customers"}, ...]
   ```

2. **`columns__data_types__and_nullable_status.json`** - Column definitions
   ```json
   [{"table_name":"customers","column_name":"customer_id","data_type":"integer","is_nullable":"NO"}, ...]
   ```

3. **`primary_keys__system_catalog_version.json`** - Primary key constraints
   ```json
   [{"table_name":"customers","constraint_name":"customers_pkey","column_name":"customer_id"}, ...]
   ```

4. **`foreign_key_relationships__source_→_target.json`** - Foreign key relationships
   ```json
   [{"source_table":"orders","source_column":"customer_id","target_table":"customers","target_column":"customer_id"}, ...]
   ```

5. **`all_in_one_schema_overview__tables__columns__pks__fks__descriptions.json`** - Complete schema with descriptions

### Sample vs. Production Schema

- **Sample files** (`sample_*.json`): Generic e-commerce schema for demonstration
- **Production files** (all other `.json`): Your actual database schema (gitignored)

### Refreshing Schema

To update schema from your PostgreSQL database:

```bash
curl -X POST http://localhost:8000/api/admin/schema/refresh \
  -H "Authorization: Bearer <admin_token>"
```

This reads the current schema from PostgreSQL and updates all JSON files.

## Application Data (`app_data/`)

Contains SQLite database files for application data:
- `sqlite.db` - Main database (users, sessions, query history, conversations)
- `*.db-shm`, `*.db-wal` - SQLite temporary files

**These files are gitignored** and should never be committed.

## Exports (`exports/`)

Stores CSV exports of query results (up to 10,000 rows per export).

**These files are gitignored** and should never be committed.

## Security Considerations

### What NOT to Commit

1. **Production Knowledge Base** - May contain business logic and sensitive queries
2. **Production Schema Files** - Reveal database structure
3. **Database Files** - Contain user data and session tokens
4. **CSV Exports** - May contain customer or business data
5. **Embeddings** - Can be regenerated, no need to commit

### .gitignore Configuration

The root `.gitignore` is configured to exclude all sensitive files:

```gitignore
# Exclude production data, allow samples
data/knowledge_base/*.sql
data/schema/*.json
!data/knowledge_base/sample_*.sql
!data/schema/sample_*.json

# Exclude generated and runtime data
data/knowledge_base/embeddings.json
data/app_data/*.db*
data/exports/*
```

## Getting Started

### Using Sample Data (Development)

The repository includes sample data that works out of the box:

1. **No additional setup needed** - Sample files are committed
2. **Generate embeddings:**
   ```bash
   make db-init  # Initialize database
   python -m backend.app.main  # Start server
   # On first run, generate embeddings via admin endpoint
   ```

### Using Production Data (Deployment)

1. **Remove sample files** (optional):
   ```bash
   rm data/knowledge_base/sample_*.sql
   rm data/schema/sample_*.json
   ```

2. **Add your data:**
   ```bash
   # Add knowledge base examples
   cp your_queries/*.sql data/knowledge_base/

   # Update POSTGRES_URL in .env
   # Generate schema via admin endpoint
   ```

3. **Generate embeddings:**
   ```bash
   curl -X POST http://localhost:8000/api/admin/knowledge-base/embeddings/generate \
     -H "Authorization: Bearer <admin_token>"
   ```

## Troubleshooting

### Schema Not Loading

If schema files are missing:
1. Check `POSTGRES_URL` in `.env`
2. Use admin endpoint to refresh: `/api/admin/schema/refresh`
3. Verify PostgreSQL connection

### Embeddings Missing

If `embeddings.json` is missing:
1. Use admin endpoint: `/api/admin/knowledge-base/embeddings/generate`
2. Check `OPENAI_API_KEY` in `.env`
3. Verify knowledge base has `.sql` files

### Permission Errors

Ensure the `data/` directory has write permissions for:
- Generating embeddings (`embeddings.json`)
- Creating database files (`app_data/*.db`)
- Exporting results (`exports/*.csv`)
